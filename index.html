<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <!-- Main Application Container -->
    <div id="app" class="w-full max-w-5xl bg-white rounded-xl shadow-2xl p-8 m-4">

        <!-- Header -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">My Awesome Store</h1>
            <nav class="flex items-center space-x-4">
                <button id="nav-home" class="text-gray-600 hover:text-blue-600 font-medium transition-colors">Home</button>
                <button id="nav-cart" class="text-gray-600 hover:text-blue-600 font-medium transition-colors relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13L4.832 18.25M17 13l-4.168 5.25A2 2 0 0110 20v-2" />
                    </svg>
                    <span id="cart-item-count" class="absolute -top-2 -right-2 bg-blue-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                </button>
                <div id="auth-buttons" class="space-x-4">
                    <button id="nav-login" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors shadow-md">Login</button>
                    <button id="nav-signup" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors shadow-md">Sign Up</button>
                </div>
                <div id="user-info" class="hidden flex items-center space-x-2">
                    <span id="username-display" class="text-gray-700 font-medium"></span>
                    <button id="nav-logout" class="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors shadow-md">Logout</button>
                </div>
            </nav>
        </header>

        <!-- Dynamic Content Area -->
        <main id="content" class="min-h-[500px]">
            <!-- Content will be rendered here -->
        </main>

    </div>

    <!-- Modal for Messages -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <h3 id="modal-message" class="text-lg font-medium text-gray-800 mb-4"></h3>
            <button id="modal-close" class="bg-blue-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-600 transition-colors">OK</button>
        </div>
    </div>

    <script>
        const app = document.getElementById('app');
        const content = document.getElementById('content');
        const navLoginBtn = document.getElementById('nav-login');
        const navSignupBtn = document.getElementById('nav-signup');
        const navLogoutBtn = document.getElementById('nav-logout');
        const navHomeBtn = document.getElementById('nav-home');
        const navCartBtn = document.getElementById('nav-cart');
        const authButtons = document.getElementById('auth-buttons');
        const userInfo = document.getElementById('user-info');
        const usernameDisplay = document.getElementById('username-display');
        const cartItemCount = document.getElementById('cart-item-count');
        const modal = document.getElementById('modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close');

        // State management
        let isLoggedIn = false;
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let username = '';
        let authToken = null; // Store JWT token

        const API_BASE_URL = 'https://e-comm-ggzb.onrender.com';

        // Update cart count on load
        updateCartCount();

        function showMessage(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // Event Listeners for Navigation
        navHomeBtn.addEventListener('click', () => {
            fetchProducts();
            updateNavigationState();
        });

        navLoginBtn.addEventListener('click', () => {
            renderLoginPage();
        });

        navSignupBtn.addEventListener('click', () => {
            renderSignupPage();
        });

        navLogoutBtn.addEventListener('click', () => {
            isLoggedIn = false;
            username = '';
            authToken = null;
            updateNavigationState();
            showMessage('You have been logged out.');
        });

        navCartBtn.addEventListener('click', () => {
            renderCartPage();
            updateNavigationState();
        });

        function updateCartCount() {
            cartItemCount.textContent = cart.length;
        }

        function updateNavigationState() {
            if (isLoggedIn) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                usernameDisplay.textContent = `Hello, ${username}!`;
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
            }
        }

        function renderLoginPage() {
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Login</h2>
                    <form id="login-form" class="w-full max-w-sm bg-gray-50 p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label for="login-username" class="block text-gray-700 font-medium mb-2">Username</label>
                            <input type="text" id="login-username" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="login-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors shadow-lg">Login</button>
                    </form>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = document.getElementById('login-username').value;
                const pass = document.getElementById('login-password').value;

                try {
                    const response = await fetch(`${API_BASE_URL}/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username: user, password: pass })
                    });
                    const data = await response.json();

                    if (response.ok) {
                        isLoggedIn = true;
                        username = data.username;
                        authToken = data.accessToken;
                        updateNavigationState();
                        fetchProducts();
                        showMessage('Login successful!');
                    } else {
                        showMessage(data);
                    }
                } catch (error) {
                    showMessage('Login failed. Please try again.');
                }
            });
        }

        function renderSignupPage() {
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800">Sign Up</h2>
                    <form id="signup-form" class="w-full max-w-sm bg-gray-50 p-6 rounded-lg shadow-md">
                        <div class="mb-4">
                            <label for="signup-username" class="block text-gray-700 font-medium mb-2">Username</label>
                            <input type="text" id="signup-username" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="signup-email" class="block text-gray-700 font-medium mb-2">Email</label>
                            <input type="email" id="signup-email" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block text-gray-700 font-medium mb-2">Password</label>
                            <input type="password" id="signup-password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors shadow-lg">Sign Up</button>
                    </form>
                </div>
            `;
            document.getElementById('signup-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const user = document.getElementById('signup-username').value;
                const pass = document.getElementById('signup-password').value;

                try {
                    const response = await fetch(`${API_BASE_URL}/signup`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username: user, password: pass })
                    });
                    const data = await response.text();
                    showMessage(data);
                    if (response.ok) {
                        renderLoginPage();
                    }
                } catch (error) {
                    showMessage('Sign up failed. Please try again.');
                }
            });
        }

        async function fetchProducts() {
            try {
                const url = new URL(`${API_BASE_URL}/items`);
                const category = document.getElementById('category-filter')?.value;
                const minPrice = document.getElementById('min-price')?.value;
                const maxPrice = document.getElementById('max-price')?.value;

                if (category && category !== 'All') url.searchParams.append('category', category);
                if (minPrice) url.searchParams.append('minPrice', minPrice);
                if (maxPrice) url.searchParams.append('maxPrice', maxPrice);

                const response = await fetch(url.toString());
                products = await response.json();
                renderProductList(products);
            } catch (error) {
                showMessage('Failed to load products.');
            }
        }

        function renderProductList(productsToRender) {
            content.innerHTML = `
                <div class="flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-8">
                    <!-- Filters Sidebar -->
                    <div class="w-full md:w-1/4 bg-gray-50 p-6 rounded-lg shadow-md self-start">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Filters</h3>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">Category</label>
                            <select id="category-filter" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="All">All</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Apparel">Apparel</option>
                                <option value="Home Goods">Home Goods</option>
                                <option value="Accessories">Accessories</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="block text-gray-700 font-medium mb-2">Price Range</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="min-price" placeholder="Min" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span class="text-gray-500">-</span>
                                <input type="number" id="max-price" placeholder="Max" class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <button id="apply-filters" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors">Apply Filters</button>
                    </div>

                    <!-- Product Grid -->
                    <div id="product-grid" class="w-full md:w-3/4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${productsToRender.map(product => `
                            <div class="product-card bg-white p-6 rounded-xl shadow-lg transition-transform transform hover:scale-105">
                                <img src="https://placehold.co/400x300/a3e635/000000?text=${product.name.split(' ')[0]}" alt="${product.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                                <h4 class="text-xl font-semibold text-gray-800">${product.name}</h4>
                                <p class="text-gray-600 mb-2">${product.category}</p>
                                <p class="text-2xl font-bold text-blue-600 mb-4">$${product.price}</p>
                                <button data-id="${product.id}" class="add-to-cart-btn w-full bg-blue-500 text-white py-2 rounded-lg font-bold hover:bg-blue-600 transition-colors shadow-md">Add to Cart</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            // Add event listeners for filters and add-to-cart buttons
            document.getElementById('apply-filters').addEventListener('click', fetchProducts);

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    if (!isLoggedIn) {
                        showMessage('Please log in to add items to your cart.');
                        return;
                    }
                    const productId = parseInt(e.target.dataset.id);
                    const productToAdd = products.find(p => p.id === productId);

                    try {
                        const response = await fetch(`${API_BASE_URL}/cart/add`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${authToken}`
                            },
                            body: JSON.stringify({ itemId: productId, quantity: 1 })
                        });

                        if (response.ok) {
                            cart.push(productToAdd);
                            localStorage.setItem('cart', JSON.stringify(cart));
                            updateCartCount();
                            showMessage(`${productToAdd.name} has been added to your cart!`);
                        } else {
                            const errorText = await response.text();
                            showMessage(`Failed to add item to cart: ${errorText}`);
                        }
                    } catch (error) {
                        showMessage('Failed to add item to cart. Please check server connection.');
                    }
                });
            });
        }

        function renderCartPage() {
            if (cart.length === 0) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13L4.832 18.25M17 13l-4.168 5.25A2 2 0 0110 20v-2" />
                        </svg>
                        <h2 class="text-2xl font-bold text-gray-800">Your cart is empty.</h2>
                        <p class="text-gray-500 mt-2">Go to the home page to add some items.</p>
                        <button id="cart-home-btn" class="mt-6 bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600 transition-colors shadow-md">Continue Shopping</button>
                    </div>
                `;
                 document.getElementById('cart-home-btn').addEventListener('click', fetchProducts);
                return;
            }
            content.innerHTML = `
                <div class="flex flex-col p-8">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 text-center">Your Shopping Cart</h2>
                    <div id="cart-items" class="space-y-6">
                        ${cart.map((item, index) => `
                            <div class="flex items-center justify-between bg-white p-6 rounded-xl shadow-lg">
                                <div class="flex items-center space-x-4">
                                    <img src="https://placehold.co/400x300/a3e635/000000?text=${item.name.split(' ')[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded-lg">
                                    <div>
                                        <h4 class="text-xl font-semibold text-gray-800">${item.name}</h4>
                                        <p class="text-gray-600">$${item.price}</p>
                                    </div>
                                </div>
                                <button data-index="${index}" class="remove-from-cart-btn bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 transition-colors shadow-md">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end items-center">
                        <span class="text-xl font-bold text-gray-800 mr-4">Total:</span>
                        <span class="text-3xl font-bold text-blue-600">$${cart.reduce((total, item) => total + item.price, 0).toFixed(2)}</span>
                    </div>
                </div>
            `;
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const indexToRemove = parseInt(e.target.dataset.index);
                    cart.splice(indexToRemove, 1);
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartCount();
                    renderCartPage();
                    showMessage('Item removed from cart.');
                });
            });
        }

        // Initial render
        fetchProducts();
        updateNavigationState();
    </script>
</body>
</html>
